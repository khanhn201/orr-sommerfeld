#!/bin/bash
#PBS -A EnergyApps
#PBS -N nek5000
#PBS -l walltime=6:00:00
#PBS -l select=8
#PBS -l place=scatter
#PBS -l filesystems=home:flare
#PBS -k doe
#PBS -j oe
export TZ='/usr/share/zoneinfo/US/Central'
cd $PBS_O_WORKDIR
echo Jobid: $PBS_JOBID
echo Running on host `hostname`
echo Running on nodes `cat $PBS_NODEFILE`
module load cmake
module load hypre
module use /soft/modulefiles/
module load ascent/develop/2025-03-19-c1f63e7-openmp
module list
export NEKRS_ASCENT_INSTALL_DIR="/soft/visualization/ascent/develop/2025-03-19-c1f63e7-openmp/ascent-checkout/"
export NEKRS_MPI_THREAD_MULTIPLE=1
export NEKRS_HOME=/lus/flare/projects/EnergyApps/khanhn/.local/nekrs_alcf_aurora_yslan
export NEK_SOURCE_ROOT=/lus/flare/projects/EnergyApps/khanhn/Nek5000
export NEKRS_GPU_MPI=0
export OCCA_DPCPP_COMPILER_FLAGS="-O3 -fsycl -fsycl-targets=intel_gpu_pvc -ftarget-register-alloc-mode=pvc:auto -fma"
export FI_CXI_RX_MATCH_MODE=hybrid
export UR_L0_USE_COPY_ENGINE=0
export MPIR_CVAR_COLL_SELECTION_TUNING_JSON_FILE=/opt/aurora/24.180.3/mpich/tuning/20230818-1024/MPIR_Coll_tuning.json
export UR_L0_REUSE_DISCARDED_EVENTS=0
export UR_L0_DISABLE_EVENTS_CACHING=1
export SYCL_PI_LEVEL_ZERO_IMMEDIATE_COMMANDLISTS_EVENT_CLEANUP_THRESHOLD=-1
export SYCL_PI_LEVEL_ZERO_REUSE_DISCARDED_EVENTS=0
export ROMIO_HINTS=.romio_hint
export MPICH_MPIIO_STATS=1
export HYPRE=1
export SOURCE_ROOT_HYPRE=$HYPRE_ROOT
export PATH=$NEK_SOURCE_ROOT/bin:$PATH

cd /lus/flare/projects/EnergyApps/khanhn/orr-sommerfeld/fsos/
CC=mpicc FC=mpif77 PPLIST="HYPRE" makenek

# actual run
# nekbmpi damBreak3D 8
mpiexec -n 800 --ppn 100 --depth 1 --cpu-bind=depth -- /lus/flare/projects/EnergyApps/khanhn/orr-sommerfeld/fsos/nek5000
